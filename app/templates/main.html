<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>现代股票分析系统 - Enhanced v3.0-Web-SSE</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main_style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🚀 现代股票分析系统 - SSE流式版</h1>
            <div class="header-info">
                <div class="version-info">
                    Enhanced v3.0-Web-SSE | WebStockAnalyzer | 完整LLM API支持 {% if auth_enabled %}| 🔐 已认证{% endif %}
                    <span id="systemStatus" class="status-indicator status-ready">系统就绪</span>
                </div>
                <div class="header-buttons">
                    <button class="config-btn" onclick="showConfig()">⚙️ AI配置</button>
                    {% if auth_enabled %}
                    <a href="{{ url_for('logout') }}" class="logout-btn">🚪 退出登录</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel - Input and Controls -->
            <div class="left-panel">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('single')">📈 单只分析</button>
                    <button class="tab" onclick="switchTab('batch')">📊 批量分析</button>
                </div>

                <!-- Single Stock Analysis -->
                <div id="singleTab" class="tab-content active">
                    <div class="form-group">
                        <label for="stockCode">股票代码</label>
                        <input type="text" id="stockCode" class="form-control" 
                               placeholder="输入股票代码（如：000001、600036、300019）">
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableStreaming" checked>
                            <label for="enableStreaming">启用流式推理显示</label>
                        </div>
                    </div>
                    
                    <button id="analyzeBtn" class="btn btn-primary" onclick="analyzeSingleStock()">
                        🔍 开始深度分析
                    </button>
                    
                    <div id="singleProgress" class="progress-bar">
                        <div class="progress-bar-fill"></div>
                    </div>
                </div>

                <!-- Batch Analysis -->
                <div id="batchTab" class="tab-content">
                    <div class="form-group">
                        <label for="stockList">股票代码列表</label>
                        <textarea id="stockList" class="form-control textarea" 
                                  placeholder="输入多个股票代码，每行一个&#10;例如：&#10;000001&#10;000002&#10;600036&#10;300019"></textarea>
                    </div>
                    
                    <button id="batchAnalyzeBtn" class="btn btn-success" onclick="analyzeBatchStocks()">
                        📊 批量深度分析
                    </button>
                    
                    <div id="batchProgress" class="progress-bar">
                        <div class="progress-bar-fill"></div>
                    </div>
                    
                    <div id="currentStock" style="display: none; margin-top: 12px; color: #6c757d; font-size: 12px; font-style: italic;"></div>
                </div>

                <!-- Log Container -->
                <div class="log-container">
                    <div class="log-header">
                        <h3>📋 分析日志</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div class="sse-status">
                                <div id="sseIndicator" class="sse-indicator"></div>
                                <span id="sseStatus">SSE断开</span>
                            </div>
                            <button class="btn btn-secondary" onclick="clearLog()" style="padding: 4px 12px; font-size: 12px;">
                                🗑️ 清空
                            </button>
                        </div>
                    </div>
                    <div id="logDisplay" class="log-display">
                        <div class="log-entry log-info">📋 系统就绪，等待分析任务...</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Results -->
            <div class="right-panel">
                <div class="results-header">
                    <h2>📋 分析结果</h2>
                    <button id="exportBtn" class="btn btn-secondary" onclick="exportReport()" style="display: none;">
                        📤 导出报告
                    </button>
                </div>

                <!-- Score Cards -->
                <div id="scoreCards" class="score-cards">
                    <div class="score-card" id="comprehensiveCard">
                        <h4>综合得分</h4>
                        <div class="score">--</div>
                        <div class="max-score">/100</div>
                    </div>
                    <div class="score-card" id="technicalCard">
                        <h4>技术分析</h4>
                        <div class="score">--</div>
                        <div class="max-score">/100</div>
                    </div>
                    <div class="score-card" id="fundamentalCard">
                        <h4>基本面</h4>
                        <div class="score">--</div>
                        <div class="max-score">/100</div>
                    </div>
                    <div class="score-card" id="sentimentCard">
                        <h4>市场情绪</h4>
                        <div class="score">--</div>
                        <div class="max-score">/100</div>
                    </div>
                </div>

                <!-- Data Quality Indicators -->
                <div id="dataQuality" class="data-quality">
                    <div class="quality-indicator">
                        <div id="financialCount" class="value">--</div>
                        <div class="label">财务指标</div>
                    </div>
                    <div class="quality-indicator">
                        <div id="newsCount" class="value">--</div>
                        <div class="label">新闻数据</div>
                    </div>
                    <div class="quality-indicator">
                        <div id="completeness" class="value">--</div>
                        <div class="label">完整度</div>
                    </div>
                </div>

                <!-- Results Content -->
                <div id="resultsContent" class="results-content">
                    <div class="empty-state">
                        <h3>📊 等待分析</h3>
                        <p>请在左侧输入股票代码并开始分析</p>
                        <p style="margin-top: 8px; font-size: 12px; color: #9ba2ab;">🌊 支持SSE实时推送</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加marked.js用于markdown解析 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    
    <script>
        // Global variables
        let currentAnalysis = null;
        let isAnalyzing = false;
        let sseConnection = null;
        let currentClientId = null;
        const API_BASE = '';  // Flask server base URL
        
        // 配置marked.js
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: false,
                smartLists: true,
                smartypants: true
            });
        }

        // SSE连接管理
        function initSSE() {
            if (sseConnection) {
                sseConnection.close();
            }

            currentClientId = generateClientId();
            const sseUrl = `${API_BASE}/sse/stream?client_id=${currentClientId}`;
            
            addLog('🌊 正在建立SSE连接...', 'info');
            
            sseConnection = new EventSource(sseUrl);
            
            sseConnection.onopen = function(event) {
                addLog('✅ SSE连接已建立', 'success');
                updateSSEStatus(true);
            };
            
            sseConnection.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleSSEMessage(data);
                } catch (e) {
                    console.error('SSE消息解析失败:', e);
                }
            };
            
            sseConnection.onerror = function(event) {
                addLog('❌ SSE连接错误', 'error');
                updateSSEStatus(false);
                
                // 自动重连
                setTimeout(() => {
                    if (!sseConnection || sseConnection.readyState === EventSource.CLOSED) {
                        addLog('🔄 尝试重新连接SSE...', 'warning');
                        initSSE();
                    }
                }, 3000);
            };
            
            sseConnection.onclose = function(event) {
                addLog('🔌 SSE连接已关闭', 'warning');
                updateSSEStatus(false);
            };
        }

        function generateClientId() {
            return 'client_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function updateSSEStatus(connected) {
            const indicator = document.getElementById('sseIndicator');
            const status = document.getElementById('sseStatus');
            
            if (connected) {
                indicator.classList.add('connected');
                status.textContent = 'SSE已连接';
            } else {
                indicator.classList.remove('connected');
                status.textContent = 'SSE断开';
            }
        }

        function handleSSEMessage(data) {
            const eventType = data.event;
            const eventData = data.data;
            
            switch (eventType) {
                case 'log':
                    addLog(eventData.message, eventData.type || 'info');
                    break;
                    
                case 'progress':
                    updateProgress(eventData.element_id, eventData.percent);
                    if (eventData.message) {
                        addLog(eventData.message, 'progress');
                    }
                    if (eventData.current_stock) {
                        document.getElementById('currentStock').textContent = 
                            `正在分析: ${eventData.current_stock}`;
                        document.getElementById('currentStock').style.display = 'block';
                    }
                    break;
                    
                case 'scores_update':
                    updateScoreCards(eventData.scores);
                    if (eventData.animate) {
                        animateScoreCards();
                    }
                    break;
                    
                case 'data_quality_update':
                    updateDataQuality(eventData);
                    break;
                    
                case 'partial_result':
                    displayPartialResults(eventData);
                    break;
                    
                case 'final_result':
                    displayResults(eventData);
                    currentAnalysis = eventData;
                    break;
                    
                case 'batch_result':
                    displayBatchResults(eventData);
                    currentAnalysis = eventData;
                    break;
                    
                case 'analysis_complete':
                    onAnalysisComplete(eventData);
                    break;
                    
                case 'analysis_error':
                    onAnalysisError(eventData);
                    break;
                    
                case 'ai_stream':
                    handleAIStream(eventData);
                    break;
                    
                case 'error':
                    addLog(`⚠️ SSE错误: ${eventData.error || '未知错误'}`, 'warning');
                    break;
                    
                case 'heartbeat':
                    // 心跳，不需要处理
                    break;
                    
                default:
                    console.log('未知SSE事件:', eventType, eventData);
            }
        }

        function handleAIStream(data) {
            // 获取或创建AI流式显示区域
            let aiStreamDiv = document.getElementById('aiStreamContent');
            if (!aiStreamDiv) {
                // 在结果区域中查找AI分析部分
                const resultsContent = document.getElementById('resultsContent');
                const aiSection = resultsContent.querySelector('.ai-analysis-content');
                
                if (aiSection) {
                    // 如果找到了AI分析部分，创建流式内容区域
                    aiStreamDiv = document.createElement('div');
                    aiStreamDiv.id = 'aiStreamContent';
                    aiStreamDiv.style.cssText = `
                        border: 2px solid #ff9800;
                        border-radius: 8px;
                        padding: 16px;
                        margin: 16px 0;
                        background: rgba(255, 152, 0, 0.1);
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        line-height: 1.6;
                        min-height: 100px;
                        white-space: pre-wrap;
                        word-wrap: break-word;
                    `;
                    
                    // 添加流式标题
                    const streamTitle = document.createElement('h3');
                    streamTitle.textContent = '🤖 AI 深度分析 - 实时生成中...';
                    streamTitle.style.cssText = 'color: #f57c00; margin-bottom: 12px; font-size: 16px;';
                    
                    const streamContainer = document.createElement('div');
                    streamContainer.appendChild(streamTitle);
                    streamContainer.appendChild(aiStreamDiv);
                    
                    // 插入到结果区域
                    resultsContent.appendChild(streamContainer);
                } else {
                    // 如果没有找到结果区域，创建临时显示区域
                    const resultsContent = document.getElementById('resultsContent');
                    resultsContent.insertAdjacentHTML('beforeend', `
                        <div style="line-height: 1.6;">
                            <h2 style="color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 12px; margin-bottom: 20px;">
                                📈 实时分析进行中...
                                <span style="font-size: 12px; color: #28a745; font-weight: normal;">🌊 AI流式生成中</span>
                            </h2>
                            
                            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                <h3 style="color: #f57c00; margin-bottom: 12px;">🤖 AI 深度分析 - 实时生成中...</h3>
                                <div id="aiStreamContent" style="color: #5d4037; font-size: 14px; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word;"></div>
                            </div>
                        </div>
                    `);
                    aiStreamDiv = document.getElementById('aiStreamContent');
                }
            }
            
            // 添加AI流式内容
            if (aiStreamDiv && data.content) {
                aiStreamDiv.textContent += data.content;
                
                // 自动滚动到底部
                aiStreamDiv.scrollTop = aiStreamDiv.scrollHeight;
                
                // 如果容器可见，也滚动到底部
                const resultsContent = document.getElementById('resultsContent');
                if (resultsContent) {
                    resultsContent.scrollTop = resultsContent.scrollHeight;
                }
            }
        }

        function animateScoreCards() {
            const cards = document.querySelectorAll('.score-card');
            cards.forEach(card => {
                card.classList.add('updating');
                setTimeout(() => {
                    card.classList.remove('updating');
                }, 1500);
            });
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Log functions
        function addLog(message, type = 'info') {
            const logDisplay = document.getElementById('logDisplay');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            let icon = '📋';
            
            switch(type) {
                case 'success': icon = '✅'; break;
                case 'warning': icon = '⚠️'; break;
                case 'error': icon = '❌'; break;
                case 'header': icon = '🎯'; break;
                case 'progress': icon = '🔄'; break;
            }
            
            logEntry.innerHTML = `<span style="color: #999;">[${timestamp}]</span> ${icon} ${message}`;
            logDisplay.appendChild(logEntry);
            logDisplay.scrollTop = logDisplay.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logDisplay').innerHTML = 
                '<div class="log-entry log-info">📋 日志已清空</div>';
        }

        // Progress bar functions
        function showProgress(elementId, show = true) {
            const progressBar = document.getElementById(elementId);
            progressBar.style.display = show ? 'block' : 'none';
            if (!show) {
                progressBar.querySelector('.progress-bar-fill').style.width = '0%';
            }
        }

        function updateProgress(elementId, percent) {
            const fill = document.getElementById(elementId).querySelector('.progress-bar-fill');
            fill.style.width = percent + '%';
        }

        // Score card functions
        function updateScoreCards(scores) {
            const cards = {
                comprehensive: document.getElementById('comprehensiveCard'),
                technical: document.getElementById('technicalCard'),
                fundamental: document.getElementById('fundamentalCard'),
                sentiment: document.getElementById('sentimentCard')
            };

            Object.keys(scores).forEach(key => {
                const card = cards[key];
                if (card) {
                    const score = scores[key];
                    card.querySelector('.score').textContent = score.toFixed(1);
                    
                    card.className = 'score-card';
                    if (score >= 80) card.classList.add('excellent');
                    else if (score >= 60) card.classList.add('good');
                    else if (score >= 40) card.classList.add('average');
                    else card.classList.add('poor');
                }
            });

            document.getElementById('scoreCards').style.display = 'grid';
        }

        function updateDataQuality(data) {
            document.getElementById('financialCount').textContent = 
                data.financial_indicators_count || 0;
            document.getElementById('newsCount').textContent = 
                data.total_news_count || 0;
            document.getElementById('completeness').textContent = 
                (data.analysis_completeness || '部分').substring(0, 2);
            
            document.getElementById('dataQuality').style.display = 'grid';
        }

        // Results display
        function showLoading() {
            document.getElementById('resultsContent').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>正在进行深度分析...</p>
                    <p style="font-size: 12px; color: #9ba2ab;">🌊 实时流式推送中</p>
                </div>
            `;
        }

        function displayPartialResults(data) {
            // 显示部分结果，比如基本信息
            const resultsContent = document.getElementById('resultsContent');
            
            if (data.type === 'basic_info') {
                resultsContent.innerHTML = `
                    <div style="line-height: 1.6;">
                        <h2 style="color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 12px; margin-bottom: 20px;">
                            📈 ${data.stock_name || data.stock_code} 分析报告
                            <span style="font-size: 12px; color: #6c757d; font-weight: normal;">🌊 实时流式分析中...</span>
                        </h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                                <h4 style="color: #495057; margin-bottom: 8px;">基本信息</h4>
                                <p><strong>股票代码:</strong> ${data.stock_code}</p>
                                <p><strong>当前价格:</strong> ¥${(data.current_price || 0).toFixed(2)}</p>
                                <p><strong>涨跌幅:</strong> ${(data.price_change || 0).toFixed(2)}%</p>
                            </div>
                            
                            <div style="background: #e3f2fd; padding: 16px; border-radius: 8px;">
                                <h4 style="color: #495057; margin-bottom: 8px;">分析进度</h4>
                                <p>🔄 正在获取技术指标...</p>
                                <p>⏳ 正在分析财务数据...</p>
                                <p>🌊 正在处理新闻情绪...</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function displayResults(report) {
            const resultsContent = document.getElementById('resultsContent');
            
            // 检查是否有AI流式内容正在显示
            const existingAIStream = document.getElementById('aiStreamContent');
            let aiAnalysisHtml = '';
            
            if (existingAIStream && existingAIStream.textContent.trim()) {
                // 如果有流式内容，使用流式内容并标记为完成
                const streamTitle = existingAIStream.parentElement.querySelector('h3');
                if (streamTitle) {
                    streamTitle.innerHTML = '🤖 AI 深度分析 <span style="color: #28a745; font-size: 12px;">✅ 生成完成</span>';
                }
                
                // 将流式内容转换为markdown格式
                const streamContent = existingAIStream.textContent;
                if (typeof marked !== 'undefined') {
                    aiAnalysisHtml = marked.parse(streamContent);
                } else {
                    aiAnalysisHtml = simpleMarkdownParse(streamContent);
                }
                
                // 更新AI分析区域
                existingAIStream.innerHTML = aiAnalysisHtml;
                existingAIStream.classList.add('ai-analysis-content');
                existingAIStream.style.whiteSpace = 'normal';
                
                // 保留现有的完整结果，只更新其他部分
                updateNonAIContent(report);
                return;
            }
        }

        function updateNonAIContent(report) {
            // 更新非AI分析的其他内容
            const resultsContent = document.getElementById('resultsContent');
            
            // 更新标题
            const title = resultsContent.querySelector('h2');
            if (title) {
                title.innerHTML = `📈 ${report.stock_name || report.stock_code} 分析报告 <span style="font-size: 12px; color: #28a745; font-weight: normal;">✅ 流式分析完成</span>`;
            }
            
            // 更新基本信息
            const basicInfoDiv = resultsContent.querySelector('div[style*="grid-template-columns"]');
            if (basicInfoDiv) {
                basicInfoDiv.innerHTML = `
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                        <h4 style="color: #495057; margin-bottom: 8px;">基本信息</h4>
                        <p><strong>股票代码:</strong> ${report.stock_code}</p>
                        <p><strong>当前价格:</strong> ¥${(report.price_info?.current_price || 0).toFixed(2)}</p>
                        <p><strong>涨跌幅:</strong> ${(report.price_info?.price_change || 0).toFixed(2)}%</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                        <h4 style="color: #495057; margin-bottom: 8px;">技术指标</h4>
                        <p><strong>RSI:</strong> ${(report.technical_analysis?.rsi || 0).toFixed(1)}</p>
                        <p><strong>趋势:</strong> ${report.technical_analysis?.ma_trend || '未知'}</p>
                        <p><strong>MACD:</strong> ${report.technical_analysis?.macd_signal || '未知'}</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                        <h4 style="color: #495057; margin-bottom: 8px;">市场情绪</h4>
                        <p><strong>情绪趋势:</strong> ${report.sentiment_analysis?.sentiment_trend || '中性'}</p>
                        <p><strong>新闻数量:</strong> ${report.sentiment_analysis?.total_analyzed || 0} 条</p>
                        <p><strong>置信度:</strong> ${((report.sentiment_analysis?.confidence_score || 0) * 100).toFixed(1)}%</p>
                    </div>
                `;
            }
            
            // 更新投资建议
            const recommendationDiv = resultsContent.querySelector('div[style*="background: #e3f2fd"]');
            if (recommendationDiv) {
                const recommendationText = recommendationDiv.querySelector('p');
                if (recommendationText) {
                    recommendationText.textContent = report.recommendation || '数据不足';
                }
            }
            
            document.getElementById('exportBtn').style.display = 'inline-flex';
        }

        // 简单的markdown解析器（备用方案）
        function simpleMarkdownParse(text) {
            if (!text) return '';
            
            return text
                .replace(/^### (.*$)/gim, '<h3 style="color: #2c3e50; margin: 16px 0 8px 0;">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 style="color: #2c3e50; margin: 20px 0 10px 0;">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 style="color: #2c3e50; margin: 24px 0 12px 0;">$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background: #f1f3f4; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #1976d2;">$1</a>')
                .replace(/^[\-\*\+] (.*$)/gim, '<li style="margin: 4px 0;">$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
        }

        function displayBatchResults(reports) {
            if (!reports || reports.length === 0) {
                addLog('批量分析结果为空', 'warning');
                return;
            }

            const avgScores = {
                comprehensive: reports.reduce((sum, r) => sum + r.scores.comprehensive, 0) / reports.length,
                technical: reports.reduce((sum, r) => sum + r.scores.technical, 0) / reports.length,
                fundamental: reports.reduce((sum, r) => sum + r.scores.fundamental, 0) / reports.length,
                sentiment: reports.reduce((sum, r) => sum + r.scores.sentiment, 0) / reports.length
            };

            updateScoreCards(avgScores);

            const avgFinancial = reports.reduce((sum, r) => sum + (r.data_quality?.financial_indicators_count || 0), 0) / reports.length;
            const avgNews = reports.reduce((sum, r) => sum + (r.sentiment_analysis?.total_analyzed || 0), 0) / reports.length;
            
            document.getElementById('financialCount').textContent = Math.round(avgFinancial);
            document.getElementById('newsCount').textContent = Math.round(avgNews);
            document.getElementById('completeness').textContent = '批量';
            document.getElementById('dataQuality').style.display = 'grid';

            const resultsContent = document.getElementById('resultsContent');
            
            let tableRows = reports
                .sort((a, b) => b.scores.comprehensive - a.scores.comprehensive)
                .map((report, index) => `
                    <tr style="border-bottom: 1px solid #e9ecef;">
                        <td style="padding: 12px; font-weight: 600;">${index + 1}</td>
                        <td style="padding: 12px;">${report.stock_code}</td>
                        <td style="padding: 12px;">${report.stock_name || report.stock_code}</td>
                        <td style="padding: 12px; font-weight: 600; color: ${report.scores.comprehensive >= 70 ? '#27ae60' : report.scores.comprehensive >= 50 ? '#667eea' : '#e74c3c'};">
                            ${report.scores.comprehensive.toFixed(1)}
                        </td>
                        <td style="padding: 12px;">${report.scores.technical.toFixed(1)}</td>
                        <td style="padding: 12px;">${report.scores.fundamental.toFixed(1)}</td>
                        <td style="padding: 12px;">${report.scores.sentiment.toFixed(1)}</td>
                        <td style="padding: 12px; font-weight: 600;">${report.recommendation}</td>
                    </tr>
                `).join('');

            const html = `
                <div style="line-height: 1.6;">
                    <h2 style="color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 12px; margin-bottom: 20px;">
                        📊 批量分析报告 (${reports.length} 只股票)
                        <span style="font-size: 12px; color: #28a745; font-weight: normal;">✅ 流式分析完成</span>
                    </h2>
                    
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 12px;">📋 分析汇总</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            <div><strong>分析数量:</strong> ${reports.length} 只</div>
                            <div><strong>平均得分:</strong> ${avgScores.comprehensive.toFixed(1)}</div>
                            <div><strong>优秀股票:</strong> ${reports.filter(r => r.scores.comprehensive >= 80).length} 只</div>
                            <div><strong>良好股票:</strong> ${reports.filter(r => r.scores.comprehensive >= 60).length} 只</div>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <th style="padding: 16px; text-align: left;">排名</th>
                                    <th style="padding: 16px; text-align: left;">代码</th>
                                    <th style="padding: 16px; text-align: left;">名称</th>
                                    <th style="padding: 16px; text-align: left;">综合得分</th>
                                    <th style="padding: 16px; text-align: left;">技术面</th>
                                    <th style="padding: 16px; text-align: left;">基本面</th>
                                    <th style="padding: 16px; text-align: left;">情绪面</th>
                                    <th style="padding: 16px; text-align: left;">投资建议</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            resultsContent.innerHTML = html;
            document.getElementById('exportBtn').style.display = 'inline-flex';
        }

        function onAnalysisComplete(data) {
            isAnalyzing = false;
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('batchAnalyzeBtn').disabled = false;
            document.getElementById('systemStatus').className = 'status-indicator status-ready';
            document.getElementById('systemStatus').textContent = '系统就绪';
            showProgress('singleProgress', false);
            showProgress('batchProgress', false);
            document.getElementById('currentStock').style.display = 'none';
            
            addLog('✅ 分析完成', 'success');
        }

        function onAnalysisError(data) {
            isAnalyzing = false;
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('batchAnalyzeBtn').disabled = false;
            document.getElementById('systemStatus').className = 'status-indicator status-error';
            document.getElementById('systemStatus').textContent = '分析失败';
            showProgress('singleProgress', false);
            showProgress('batchProgress', false);
            document.getElementById('currentStock').style.display = 'none';
            
            document.getElementById('resultsContent').innerHTML = `
                <div class="empty-state">
                    <h3>❌ 分析失败</h3>
                    <p>${data.error || '未知错误'}</p>
                </div>
            `;
            
            addLog(`❌ 分析失败: ${data.error}`, 'error');
        }

        // Analysis functions with SSE support
        async function analyzeSingleStock() {
            const stockCode = document.getElementById('stockCode').value.trim();
            if (!stockCode) {
                addLog('请输入股票代码', 'warning');
                return;
            }

            if (isAnalyzing) {
                addLog('分析正在进行中，请稍候', 'warning');
                return;
            }

            isAnalyzing = true;
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('systemStatus').className = 'status-indicator status-analyzing';
            document.getElementById('systemStatus').textContent = '分析中';

            addLog(`🚀 开始流式分析股票: ${stockCode}`, 'header');
            showLoading();
            showProgress('singleProgress');

            try {
                const response = await fetch(`${API_BASE}/analyze/streaming`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stock_code: stockCode,
                        enable_streaming: document.getElementById('enableStreaming').checked,
                        client_id: currentClientId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || '分析失败');
                }

            } catch (error) {
                onAnalysisError({error: error.message});
            }
        }

        async function analyzeBatchStocks() {
            const stockListText = document.getElementById('stockList').value.trim();
            if (!stockListText) {
                addLog('请输入股票代码列表', 'warning');
                return;
            }

            if (isAnalyzing) {
                addLog('分析正在进行中，请稍候', 'warning');
                return;
            }

            const stockList = stockListText.split('\n').map(s => s.trim()).filter(s => s);
            if (stockList.length === 0) {
                addLog('股票代码列表为空', 'warning');
                return;
            }

            isAnalyzing = true;
            document.getElementById('batchAnalyzeBtn').disabled = true;
            document.getElementById('systemStatus').className = 'status-indicator status-analyzing';
            document.getElementById('systemStatus').textContent = '批量分析中';

            addLog(`📊 开始流式批量分析 ${stockList.length} 只股票`, 'header');
            showLoading();
            showProgress('batchProgress');
            document.getElementById('currentStock').style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/analyze/batch_streaming`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stock_codes: stockList,
                        client_id: currentClientId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || '批量分析失败');
                }

            } catch (error) {
                onAnalysisError({error: error.message});
            }
        }

        // Configuration (保持不变)
        function showConfig() {
            addLog('⚙️ 打开配置对话框', 'info');
            
            fetch(`${API_BASE}/status/system_info`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const apis = data.data.configured_apis || [];
                        const versions = data.data.api_versions || {};
                        const primary = data.data.primary_api || 'openai';
                        
                        let configInfo = `🔧 Enhanced v3.0-Web-SSE AI配置状态

🎯 当前系统状态：
✅ 分析器：WebStockAnalyzer (SSE流式版)
✅ 高并发：${data.data.max_workers}个工作线程
✅ 活跃任务：${data.data.active_tasks}个
🌊 流式推送：SSE Server-Sent Events

🤖 AI API配置状态：`;

                        if (apis.length > 0) {
                            configInfo += `
✅ 已配置API：${apis.join(', ')}
🎯 主要API：${primary}

API版本详情：`;
                            apis.forEach(api => {
                                const version = versions[api] || '未知';
                                const status = version.includes('未安装') ? '❌' : '✅';
                                configInfo += `
${status} ${api}: ${version}`;
                            });
                            
                            configInfo += `

🚀 AI分析功能：完全可用
✅ 深度财务分析 (25项指标)
✅ 技术面精准解读  
✅ 市场情绪挖掘
✅ 综合投资策略
✅ 风险机会识别
🌊 实时流式推送`;
                        } else {
                            configInfo += `
⚠️ 未配置任何AI API密钥
🔧 当前使用：高级规则分析模式`;
                        }

                        configInfo += `

📋 配置方法：
1. 编辑项目目录下的 config.json 文件
2. 在 api_keys 部分填入您的API密钥
3. 重启服务器生效

🌟 推荐配置：
• OpenAI GPT-4o-mini (性价比首选)
• Claude-3-haiku (分析质量优秀)
• 智谱AI ChatGLM (国内网络稳定)

💡 新特性：
• 🌊 SSE实时流式推送
• 📊 实时进度显示
• 🔄 动态结果更新
• 🚀 更佳用户体验

📁 相关文件：
• 配置文件：config.json
• 分析器：web_stock_analyzer.py (修正版)
• 服务器：flask_web_server.py (SSE版)`;

                        alert(configInfo);
                    }
                })
                .catch(error => {
                    const fallbackInfo = `🔧 Enhanced v3.0-Web-SSE AI配置管理

❌ 无法获取当前配置状态，请检查服务器连接

📋 基本配置方法：
1. 在项目目录创建或编辑 config.json
2. 填入AI API密钥
3. 重启服务器

🌊 新特性：支持SSE实时流式推送

💡 如需帮助，请查看控制台日志`;
                    alert(fallbackInfo);
                });
        }

        // Export report (保持不变，但添加SSE标识)
        function exportReport() {
            if (!currentAnalysis) {
                addLog('⚠️ 没有可导出的报告', 'warning');
                return;
            }

            try {
                addLog('📤 开始导出分析报告...', 'info');
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                let content, filename, reportType;

                if (Array.isArray(currentAnalysis)) {
                    reportType = `批量分析(${currentAnalysis.length}只股票)`;
                    filename = `batch_analysis_sse_${timestamp}.md`;
                    content = generateBatchMarkdown(currentAnalysis);
                } else {
                    reportType = `单个股票(${currentAnalysis.stock_code})`;
                    filename = `stock_analysis_sse_${currentAnalysis.stock_code}_${timestamp}.md`;
                    content = generateSingleMarkdown(currentAnalysis);
                }

                const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);

                addLog(`✅ ${reportType}报告导出成功: ${filename}`, 'success');
                
                const fileSize = (content.length / 1024).toFixed(1);
                setTimeout(() => {
                    alert(`SSE流式分析报告已导出！\\n\\n📄 文件名：${filename}\\n📊 报告类型：${reportType}\\n📏 文件大小：${fileSize} KB\\n🌊 分析方式：SSE实时流式推送\\n🔧 分析器：Enhanced v3.0-Web-SSE | WebStockAnalyzer`);
                }, 100);

            } catch (error) {
                const errorMsg = `导出失败：${error.message}`;
                addLog(`❌ ${errorMsg}`, 'error');
                alert(errorMsg);
            }
        }

        function generateSingleMarkdown(report) {
            const aiAnalysis = report.ai_analysis || '分析数据准备中...';
            
            return `# 📈 股票分析报告 (Enhanced v3.0-Web-SSE)

## 🏢 基本信息
| 项目 | 值 |
|------|-----|
| **股票代码** | ${report.stock_code} |
| **股票名称** | ${report.stock_name} |
| **分析时间** | ${report.analysis_date} |
| **当前价格** | ¥${report.price_info.current_price.toFixed(2)} |
| **价格变动** | ${report.price_info.price_change.toFixed(2)}% |

## 📊 综合评分

### 🎯 总体评分：${report.scores.comprehensive.toFixed(1)}/100

| 维度 | 得分 | 评级 |
|------|------|------|
| **技术分析** | ${report.scores.technical.toFixed(1)}/100 | ${getScoreRating(report.scores.technical)} |
| **基本面分析** | ${report.scores.fundamental.toFixed(1)}/100 | ${getScoreRating(report.scores.fundamental)} |
| **情绪分析** | ${report.scores.sentiment.toFixed(1)}/100 | ${getScoreRating(report.scores.sentiment)} |

## 🎯 投资建议

### ${report.recommendation}

## 🤖 AI综合分析

${aiAnalysis}

---
*报告生成时间：${new Date().toLocaleString('zh-CN')}*  
*分析器版本：Enhanced v3.0-Web-SSE*  
*分析器类：WebStockAnalyzer (SSE流式版)*  
*推送方式：Server-Sent Events 实时流式*  
*数据来源：多维度综合分析*
`;
        }

        function generateBatchMarkdown(reports) {
            let content = `# 📊 批量股票分析报告 - Enhanced v3.0-Web-SSE

**分析时间：** ${new Date().toLocaleString('zh-CN')}
**分析数量：** ${reports.length} 只股票
**分析器版本：** Enhanced v3.0-Web-SSE
**分析器类：** WebStockAnalyzer (SSE流式版)
**推送方式：** Server-Sent Events 实时流式

## 📋 分析汇总

| 排名 | 股票代码 | 股票名称 | 综合得分 | 技术面 | 基本面 | 情绪面 | 投资建议 |
|------|----------|----------|----------|--------|--------|--------|----------|
`;

            reports.sort((a, b) => b.scores.comprehensive - a.scores.comprehensive)
                   .forEach((report, index) => {
                content += `| ${index + 1} | ${report.stock_code} | ${report.stock_name} | ${report.scores.comprehensive.toFixed(1)} | ${report.scores.technical.toFixed(1)} | ${report.scores.fundamental.toFixed(1)} | ${report.scores.sentiment.toFixed(1)} | ${report.recommendation} |\n`;
            });

            content += `\n## 📈 详细分析\n\n`;
            
            reports.forEach(report => {
                content += generateSingleMarkdown(report);
                content += '\n---\n\n';
            });

            return content;
        }

        function getScoreRating(score) {
            if (score >= 80) return '优秀';
            if (score >= 60) return '良好';
            if (score >= 40) return '一般';
            return '较差';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            
            // 初始化SSE连接
            initSSE();
            
            // 检查服务器连接和系统信息
            fetch(`${API_BASE}/status/system_info`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLog('✅ 后端服务器连接成功', 'success');
                        addLog(`🔧 系统状态：${data.data.active_tasks} 个活跃任务`, 'info');
                        addLog(`🧵 线程池：${data.data.max_workers} 个工作线程`, 'info');
                        
                        addLog(`🤖 AI API已配置: ${data.data.primary_api}`, 'success');
                        
                        addLog('🚀 支持完整AI深度分析', 'success');
                    }
                })
                .catch(error => {
                    addLog('❌ 后端服务器连接失败，请检查服务器状态', 'error');
                });
        });

        // 页面卸载时关闭SSE连接
        window.addEventListener('beforeunload', function() {
            if (sseConnection) {
                sseConnection.close();
            }
        });
    </script>
</body>
</html>